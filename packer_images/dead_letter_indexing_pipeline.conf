input {
  dead_letter_queue {
    path => "/var/lib/logstash/dead_letter_queue"
    commit_offsets => true
    pipeline_id => "main"
  }
}

filter {

  # prune every field off the event except for the one whitelisted. Note that this does not prune event metadata.
  prune {
    whitelist_names => [ "^failed_case$" ]
  }

  ruby {
    code => "event.set('timestamp', event.get('[@metadata][dead_letter_queue][entry_time]'))"
  }

  # pull useful information out of the event metadata provided by the dead letter queue, and add it to the new event.
  mutate {
    add_field => {
      "reason" => "%{[@metadata][dead_letter_queue][reason]}"
    }
  }
}

output {
  elasticsearch {
    hosts => ["ES_URL:9200"]
    sniffing => false
    index => ".logstash_dead_letter"
  }
}
